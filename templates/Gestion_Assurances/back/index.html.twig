{% extends 'Back/base.html.twig' %}

{% block title %}Gestion des Assurances - Administration{% endblock %}

{% block body %}
    <div class="dashboard-container">
        <div class="dashboard-header">
            <h1 class="dashboard-title">Gestion des Assurances</h1>
            <p class="dashboard-subtitle">Liste de toutes les assurances disponibles</p>
        </div>

        <div class="stats-container">
            <div class="stat-box stat-total">
                <i class="fas fa-chart-pie stat-icon"></i>
                <div class="stat-info">
                    <span class="stat-label">Total</span>
                    <span class="stat-value">{{ assurances|length }}</span>
                </div>
            </div>
            <div class="stat-box stat-active">
                <i class="fas fa-check-circle stat-icon"></i>
                <div class="stat-info">
                    <span class="stat-label">Actives</span>
                    <span class="stat-value">{{ assurances|filter(a => a.statut == 'Active')|length }}</span>
                </div>
            </div>
            <div class="stat-box stat-expired">
                <i class="fas fa-times-circle stat-icon"></i>
                <div class="stat-info">
                    <span class="stat-label">Expirées</span>
                    <span class="stat-value">{{ assurances|filter(a => a.statut == 'Expirée')|length }}</span>
                </div>
            </div>
            <div class="stat-box stat-pending">
                <i class="fas fa-hourglass-half stat-icon"></i>
                <div class="stat-info">
                    <span class="stat-label">En attente</span>
                    <span class="stat-value">{{ assurances|filter(a => a.statut == 'En attente')|length }}</span>
                </div>
            </div>
        </div>

        <div class="table-top">
            <div class="search-filter">
                <input type="text" class="search-input" placeholder="Rechercher une assurance...">
                <select class="filter-dropdown">
                    <option value="">Tous les statuts</option>
                    <option value="Active">Active</option>
                    <option value="Expirée">Expirée</option>
                    <option value="En attente">En attente</option>
                </select>
            </div>
            <a href="{{ path('app_admin_assurance_new') }}" class="add-btn">
                <i class="fas fa-plus"></i>
                Nouvelle Assurance
            </a>
        </div>

        <table class="data-table">
            <thead>
                <tr>
                    <th>ID Contrat</th>
                    <th>Type de couverture</th>
                    <th>Durée</th>
                    <th>Date de début</th>
                    <th>Statut</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for assurance in assurances %}
                    <tr>
                        <td>{{ assurance.ID_contrat }}</td>
                        <td>{{ assurance.typeDeCouverture }}</td>
                        <td>{{ assurance.duree }} mois</td>
                        <td>{{ assurance.dateDebut }}</td>
                        <td>
                            <span class="badge {% if assurance.statut == 'Active' %}badge-success{% elseif assurance.statut == 'Expirée' %}badge-danger{% else %}badge-warning{% endif %}">
                                {{ assurance.statut }}
                            </span>
                        </td>
                        <td class="action-cell">
                            <a href="{{ path('app_admin_assurance_show', {'ID_contrat': assurance.ID_contrat}) }}" class="action-btn view" title="Voir">
                                <i class="fas fa-eye"></i>
                            </a>
                            <a href="{{ path('app_admin_assurance_edit', {'ID_contrat': assurance.ID_contrat}) }}" class="action-btn edit" title="Modifier">
                                <i class="fas fa-edit"></i>
                            </a>
                            <button class="action-btn delete" title="Supprimer" onclick="openDeleteModal('{{ assurance.ID_contrat }}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                {% else %}
                    <tr>
                        <td colspan="6" class="text-center">Aucune assurance trouvée</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>

        <div class="pagination">
            <button class="page-btn"><i class="fas fa-chevron-left"></i></button>
            <button class="page-btn active">1</button>
            <button class="page-btn">2</button>
            <button class="page-btn">3</button>
            <button class="page-btn"><i class="fas fa-chevron-right"></i></button>
        </div>
    </div>

    <!-- Modal de suppression -->
    <div class="modal-backdrop" id="deleteModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Confirmer la suppression</h3>
                <button class="modal-close" onclick="closeDeleteModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p>Êtes-vous sûr de vouloir supprimer cette assurance ?</p>
            </div>
            <div class="modal-footer">
                <button class="modal-btn cancel" onclick="closeDeleteModal()">Annuler</button>
                <form id="deleteForm" method="post" action="">
                    <input type="hidden" name="_token" value="{{ csrf_token('delete') }}">
                    <input type="hidden" name="_method" value="DELETE">
                    <input type="hidden" name="id" id="assurance_id" value="">
                    <button class="modal-btn confirm">Supprimer</button>
                </form>
            </div>
        </div>
    </div>
{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <style>
        .stats-container { display: flex; gap: 1rem; margin: 1.5rem 0; }
        .stat-box { background: #fff; flex: 1; padding: 1rem; border-radius: .5rem; box-shadow: 0 2px 5px rgba(0,0,0,0.1); display: flex; align-items: center; }
        .stat-icon { font-size: 1.5rem; margin-right: 0.75rem; color: #6c757d; }
        .stat-info { text-align: left; }
        .stat-label { font-size: 0.85rem; color: #6c757d; }
        .stat-value { font-size: 1.4rem; font-weight: 600; display: block; }
        .stat-box.stat-total .stat-icon { color: #007bff; }
        .stat-box.stat-active .stat-icon { color: #28a745; }
        .stat-box.stat-expired .stat-icon { color: #dc3545; }
        .stat-box.stat-pending .stat-icon { color: #ffc107; }
    </style>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script>
        function openDeleteModal(id) {
            const modal = document.getElementById('deleteModal');
            const form = document.getElementById('deleteForm');
            document.getElementById('assurance_id').value = id;
            form.action = "/admin/assurance/" + id + "/delete";
            modal.classList.add('show');
        }

        function closeDeleteModal() {
            const modal = document.getElementById('deleteModal');
            document.getElementById('assurance_id').value = '';
            modal.classList.remove('show');
        }

        // Recherche et filtrage
        document.querySelector('.search-input').addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            const rows = document.querySelectorAll('.data-table tbody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        });

        document.querySelector('.filter-dropdown').addEventListener('change', function(e) {
            const filterValue = e.target.value;
            const rows = document.querySelectorAll('.data-table tbody tr');
            
            rows.forEach(row => {
                if (!filterValue) {
                    row.style.display = '';
                    return;
                }
                
                const statusCell = row.querySelector('td:nth-child(5)');
                if (statusCell) {
                    const status = statusCell.textContent.trim();
                    row.style.display = status === filterValue ? '' : 'none';
                }
            });
        });
    </script>
{% endblock %}